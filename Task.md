# Task.md — опорный документ проекта Local RAG Assistant

## 1. Назначение документа

Этот документ — единая **входная точка** для новых участников проекта (разработчиков, аналитиков, тестировщиков, DevOps и ИИ-агентов).  
Цель: быстро дать контекст по продукту, архитектуре, ограничениям, рабочим процессам и правилам изменений.

---

## 2. Краткое описание продукта

**Local RAG Assistant** — локальный NotebookLM-подобный ассистент для работы с документами пользователя в рамках «ноутбуков».

### 2.1 Ключевые идеи
- Пользователь создает один или несколько **ноутбуков** (изолированные рабочие области).
- В ноутбук загружаются документы (pdf/docx/xlsx/txt/log/doc).
- Система парсит документы, строит индекс и отвечает на вопросы по содержимому.
- Ответы сопровождаются ссылками на источники (цитатами).

### 2.2 Базовые ограничения среды
- Приложение ориентировано на работу в закрытых контурах предприятия.
- Подключение LLM/embedding/reranker выполняется через локальную инфраструктуру предприятия.
- Интернет-доступ может отсутствовать полностью.

---

## 3. Термины и сущности

- **Ноутбук** — логическая папка/проект пользователя с собственными документами и контекстом диалога.
- **Source (источник)** — отдельный загруженный файл в ноутбуке.
- **Parsing** — извлечение и нормализация текста из файла.
- **Chunk** — фрагмент текста для индексации и retrieval.
- **Indexing** — сохранение и подготовка чанков для поиска.
- **Retrieval** — поиск релевантных фрагментов по вопросу пользователя.
- **Citation** — структурированная ссылка на фрагмент источника (файл/страница/секция).
- **SSE stream** — поток событий с частями ответа в UI (`token` / `citations` / `done`).

---

## 4. Продуктовые цели

### 4.1 Цели MVP/текущей версии
1. Надежный ingest-флоу: загрузка файла → парсинг → индексация без «падений».
2. Быстрый доступ к ответам по документам внутри выбранного ноутбука.
3. Прозрачность через цитирование источников в ответе.
4. Стабильная локальная работа без зависимости от внешних облаков.

### 4.2 Что не является целью на текущем этапе
- Полноценный универсальный «агент общего назначения».
- Обязательная генерация ответа только LLM-моделью (допускаются template/fallback режимы).
- Глобальная меж-ноутбучная база знаний по умолчанию.

---

## 5. Функциональные требования

### 5.1 Главное меню
При входе пользователь попадает в стартовое окно и может:
- создать ноутбук;
- выбрать ноутбук;
- переименовать ноутбук;
- удалить ноутбук.

### 5.2 Явные функции элементов главного меню
- **Создать ноутбук**
  - создает новую изолированную рабочую область;
  - инициализирует хранилище документов и индексов;
  - делает ноутбук доступным в списке выбора.
- **Выбрать ноутбук**
  - открывает рабочее окно конкретного ноутбука;
  - загружает список источников, историю и текущие настройки контекста;
  - переключает весь retrieval/чат на выбранный notebook scope.
- **Переименовать ноутбук**
  - изменяет отображаемое имя без потери данных;
  - сохраняет идентификатор и связи с существующими источниками.
- **Удалить ноутбук**
  - удаляет метаданные ноутбука и связанные артефакты индекса;
  - требует подтверждение действия;
  - после удаления недоступен для retrieval и чата.

### 5.3 Основное рабочее окно
Состоит из трех зон:
1. **Центральная секция** — чат, ответы, citations и системные сообщения.
2. **Левая сворачиваемая секция** — работа с источниками и состоянием индексации.
3. **Правая сворачиваемая секция** — настройки LLM/парсинга/поведения чата.

### 5.4 Явные функции элементов рабочего окна
- **Центральная секция (Chat Panel)**
  - принимает вопрос пользователя;
  - показывает потоковую генерацию ответа;
  - визуализирует citations и фрагменты-основания;
  - отображает ошибки запроса/генерации в человеко-читаемом виде.
- **Левая секция (Sources Panel)**
  - загрузка новых документов в текущий ноутбук;
  - просмотр списка sources и их статусов (`uploaded/indexing/indexed/failed`);
  - ручной запуск/повтор индексации для проблемных источников;
  - удаление источника из контекста ноутбука.
- **Правая секция (Settings Panel)**
  - подключение/отключение LLM провайдера;
  - настройка embedding/retrieval параметров;
  - настройка правил парсинга/чанкинга;
  - сохранение пользовательских параметров между сессиями.

### 5.5 Правая панель настроек (базовая структура)
1. **Провайдер LLM**
   - настройки чата (endpoint, model, timeout, режим работы),
   - настройки эмбеддинга (модель, размерность, пакетный режим),
   - дополнительные подблоки (reranker, generation policy, профили).
2. **Глобальные настройки парсинга**
   - параметры извлечения текста по форматам,
   - параметры чанкинга (размер, overlap, границы секций),
   - деградационные fallback-режимы и их приоритет.

### 5.6 Поведение настроек
- Настройки сохраняются между сессиями.
- По умолчанию LLM-провайдер может быть в режиме `None`.
- Пользователь вручную запускает/подключает нужный провайдер по сохраненным или обновленным параметрам.
- Некорректные значения настроек валидируются до старта запроса.

### 5.7 Чат и ответы
- Вопрос пользователя обрабатывается в контексте выбранного ноутбука.
- Ответ возвращается потоково (SSE) или пакетно (по режиму).
- В ответе должны присутствовать citations релевантных источников.
- При отсутствии релевантных данных система возвращает безопасный fallback-ответ.

---

## 6. Нефункциональные требования

### 6.1 Надежность
- Ошибки парсинга отдельного файла не должны ломать все приложение.
- При невозможности полного извлечения должен быть fallback c диагностикой.
- Фоновые задачи индексации должны быть идемпотентными при повторном запуске.

### 6.2 Безопасность и приватность
- Все данные хранятся локально в контуре пользователя/предприятия.
- Доступ к внешним API должен быть контролируемым и отключаемым.
- Логи не должны содержать чувствительные данные в открытом виде.

### 6.3 Производительность
- Индексация должна выполняться в фоне и иметь наблюдаемый статус.
- Retrieval должен быть быстрым для интерактивного чата.
- Поддерживается поэтапная обработка крупных файлов без блокировки UI.

### 6.4 Расширяемость
- Возможность добавлять новые парсеры, стратегии поиска, reranker/LLM-провайдеры.
- Минимальная связанность между UI, API и ядром обработки.
- Новые режимы должны встраиваться без перелома существующих API-контрактов.

---

## 7. Архитектура (системный обзор)

### 7.1 Компоненты
- **Frontend (`apps/web`)**: пользовательский интерфейс (ноутбуки, источники, чат, настройки).
- **Backend (`apps/api`)**: API, маршруты, жизненный цикл notebook/source, индексация, retrieval, SSE.
- **Core (`packages/rag_core`)**: парсинг и legacy/расширенные алгоритмы обработки и поиска.

### 7.2 Сквозной поток данных
1. Пользователь загружает документ.
2. Backend сохраняет файл в хранилище ноутбука.
3. Сервис парсинга извлекает блоки текста.
4. Сервис индексации строит индексные записи.
5. При запросе в чат retrieval выбирает релевантные chunks.
6. Генерируется ответ и citations, UI получает стрим событий.

### 7.3 Алгоритм обработки документа (ingest pipeline)
1. **Pre-check**
   - проверка типа/расширения файла;
   - проверка лимитов размера и базовой валидности.
2. **Extraction**
   - извлечение текста специализированным обработчиком по формату;
   - при ошибке — fallback extraction с техническим маркером причины.
3. **Normalization**
   - очистка управляющих символов;
   - нормализация пробелов, переносов и кодировок.
4. **Sectioning**
   - поиск структурных границ (заголовки/подразделы/страницы);
   - формирование секций с метаданными.
5. **Chunking**
   - разбиение секций на chunks целевого размера;
   - поддержка overlap для сохранения контекста между чанками.
6. **Metadata enrichment**
   - добавление служебных полей: source_id, filename, page/section, timestamps.
7. **Index write**
   - сохранение chunk-записей в notebook index;
   - обновление статуса источника.

### 7.4 Алгоритм поиска и генерации ответа (query pipeline)
1. **Query normalization**
   - очистка вопроса пользователя;
   - выделение ключевых токенов/фраз.
2. **Candidate retrieval**
   - первичный отбор чанков по keyword/TF-IDF/embedding (в зависимости от режима).
3. **Re-ranking (опционально)**
   - пересортировка кандидатов reranker-моделью или эвристикой релевантности.
4. **Context assembly**
   - сбор финального контекста из top-K chunks;
   - удаление явных дублей/шумовых фрагментов.
5. **Answer generation**
   - template-based или LLM-генерация (по конфигурации);
   - соблюдение ограничений по длине и формату ответа.
6. **Citation mapping**
   - привязка фрагментов ответа к источникам;
   - формирование структурированных citations для UI.
7. **Streaming/output**
   - отправка токенов и финального блока citations через SSE;
   - завершение события `done`.

### 7.5 Деградационные режимы
- Если LLM недоступна: вернуть извлеченный фактологический ответ по retrieval-контексту.
- Если retrieval вернул пустой набор: вернуть «недостаточно данных» без галлюцинаций.
- Если парсинг частично провален: индексировать доступные блоки и показать диагностический статус.

---

## 8. Операционная модель и состояния

### 8.1 Состояния источника
- `uploaded` → `indexing` → `indexed` / `failed`.

### 8.2 Состояния диалога
- `idle` → `requesting` → `streaming` → `done` / `error`.

### 8.3 Наблюдаемость
Минимум, который должен быть доступен в UI/API:
- статус индексации;
- счетчики обработанных источников;
- сообщение об ошибке при `failed`;
- время выполнения ключевых этапов;
- технические логи backend.

---

## 9. Роли в команде и зона ответственности

- **Product/Analyst**: уточняет пользовательские сценарии, UX-потоки, критерии приемки.
- **Backend**: API-контракты, индексация, retrieval, стабильность пайплайна.
- **Frontend**: UX чата/источников/настроек, корректное отображение статусов и citations.
- **ML/LLM Engineer**: конфигурация моделей, качество retrieval/rerank, eval-процессы.
- **QA**: e2e, регресс, проверка деградационных режимов.
- **DevOps**: среда запуска, обновления, логирование, внутренние поставки.

---

## 10. Правила внесения изменений

1. Любое изменение API должно сопровождаться обновлением DTO/схем и фронтового клиента.
2. Изменения в parsing/indexing требуют проверки деградационных сценариев.
3. Новые настройки должны иметь:
   - значение по умолчанию;
   - сохранение между сессиями;
   - отображение в UI;
   - краткое описание назначения.
4. При добавлении новых режимов retrieval фиксировать влияние на качество ответов и citations.
5. Изменения алгоритмов должны сопровождаться обновлением этого документа.

---

## 11. Онбординг для нового специалиста/ИИ-агента (чеклист)

1. Прочитать этот `Task.md` целиком.
2. Изучить `README.md` и карту модулей.
3. Поднять API и Web локально.
4. Пройти smoke-сценарий: создать ноутбук → загрузить файл → дождаться индексации → задать вопрос.
5. Зафиксировать наблюдения по логам и UX.
6. Только после этого браться за feature/fix.

---

## 12. Контрольный сценарий приемки (базовый)

1. Создать новый ноутбук.
2. Загрузить 2–3 документа разных форматов.
3. Убедиться, что статусы источников дошли до `indexed` (или корректно в `failed` с причиной).
4. Задать вопрос, ответ на который содержится в документах.
5. Проверить, что в ответе есть citations.
6. Отключить LLM и проверить fallback-режим ответа.
7. Перезапустить приложение и убедиться, что настройки и состояние не потеряны.

---

## 13. Риски и открытые вопросы

- Разнородность качества извлечения для тяжелых форматов (pdf/docx/xlsx).
- Необходимость стандартизовать политику fallback-ответов.
- Требуется единая стратегия оценки качества retrieval/ответов.
- Возможны узкие места по производительности на больших ноутбуках.

---

## 14. Roadmap (черновой)

### Этап 1 — стабилизация текущего контура
- повысить надежность парсинга;
- улучшить статусы и диагностические сообщения;
- покрыть критические API-тестами.

### Этап 2 — качество ответов
- добавить/улучшить reranking;
- внедрить управляемые режимы генерации (template/LLM/hybrid);
- расширить метаданные citations.

### Этап 3 — enterprise-готовность
- профили конфигураций под разные контуры;
- аудит и безопасность;
- инструменты обслуживания (резервирование/миграции/мониторинг).

---

## 15. Принципы работы ИИ-агента в этом репозитории

1. Перед изменениями уточнять фактическое состояние модулей в коде.
2. Не ломать совместимость UI ↔ API без явного migration-плана.
3. Делать изменения атомарно и проверяемо.
4. В итоговых отчетах указывать:
   - что изменено;
   - как проверено;
   - какие ограничения среды повлияли на результат.

---

## 16. Критерий «документ актуален»

`Task.md` считается актуальным, если:
- отражает текущую архитектуру и пользовательский поток;
- содержит понятный чеклист онбординга;
- описывает целевые состояния системы и критерии приемки;
- включает явные функции элементов меню/интерфейса;
- помогает новому участнику запуститься без устной передачи знаний.
